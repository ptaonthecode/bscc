import React, { useState, useMemo } from 'react';
import { 
  Menu, Search, Bell, Settings, User, 
  PieChart, BarChart2, Briefcase, 
  FileText, MessageSquare, Monitor, 
  ChevronDown, Maximize2, X
} from 'lucide-react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, 
  Tooltip, ResponsiveContainer 
} from 'recharts';

// --- Types ---
interface Stock {
  id: string;
  symbol: string;
  vol: number;         // Tổng khối lượng (Editable)
  avail: number;       // Khối lượng khả dụng (Editable)
  costPrice: number;   // Giá vốn (Editable)
  marketPrice: number; // Giá thị trường (Editable)
}

// --- Initial Data ---
const initialStocks: Stock[] = [
  { id: '1', symbol: 'BCG', vol: 100, avail: 100, costPrice: 2.98, marketPrice: 2.53 },
  { id: '2', symbol: 'CEO', vol: 925, avail: 925, costPrice: 25.92, marketPrice: 24.70 },
  { id: '3', symbol: 'DQS', vol: 200, avail: 200, costPrice: 0.50, marketPrice: 0.80 },
  { id: '4', symbol: 'HHG', vol: 140, avail: 140, costPrice: 1.50, marketPrice: 1.40 },
  { id: '5', symbol: 'TCB', vol: 1000, avail: 1000, costPrice: 33.50, marketPrice: 33.90 },
];

const chartData = [
  { date: '1', profit: 0, index: 0 },
  { date: '2', profit: 2, index: 1 },
  { date: '3', profit: 5, index: 2 },
  { date: '4', profit: 3, index: 1.5 },
  { date: '5', profit: 8, index: 3 },
  { date: '6', profit: 6, index: 2.5 },
  { date: '7', profit: 10, index: 4 },
  { date: '8', profit: 9, index: 5 },
  { date: '9', profit: 12, index: 6 },
  { date: '10', profit: 10, index: 7 },
];

// --- Components ---

const SidebarItem = ({ icon: Icon, active = false }: { icon: any, active?: boolean }) => (
  <div className={`p-3 cursor-pointer hover:bg-gray-800 transition-colors ${active ? 'text-blue-500 border-l-2 border-blue-500' : 'text-gray-400'}`}>
    <Icon size={20} />
  </div>
);

const ToggleSwitch = () => (
  <div className="w-8 h-4 bg-gray-600 rounded-full relative cursor-pointer">
    <div className="w-4 h-4 bg-white rounded-full absolute left-0 top-0 shadow-sm transform transition-transform duration-200"></div>
  </div>
);

const InfoRow = ({ label, value, isHighlight = false, valueColor = 'text-white' }: { label: string, value: string | number, isHighlight?: boolean, valueColor?: string }) => (
  <div className={`flex justify-between items-center py-2 border-b border-gray-800 ${isHighlight ? 'font-bold' : 'text-sm'}`}>
    <span className="text-gray-400">{label}</span>
    <span className={valueColor}>{value}</span>
  </div>
);

// Input Component with "no-spinner" class to hide arrows
const EditableNumber = ({ value, onChange, className = "" }: { value: number, onChange: (val: number) => void, className?: string }) => (
  <input
    type="number"
    value={value}
    onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
    className={`bg-transparent border-b border-transparent hover:border-gray-600 focus:border-blue-500 outline-none text-right w-full text-white transition-colors cursor-text no-spinner ${className}`}
  />
);

export default function BSCDashboard() {
  const [stocks, setStocks] = useState<Stock[]>(initialStocks);
  const [cashBalance, setCashBalance] = useState(9175933); 

  // --- Calculations ---
  
  const { processedStocks, totals } = useMemo(() => {
    let totalCostVal = 0;
    let totalMarketVal = 0;

    const processed = stocks.map(stock => {
      const costVal = stock.vol * stock.costPrice * 1000;
      const marketVal = stock.vol * stock.marketPrice * 1000;
      const pl = marketVal - costVal;
      const plPercent = costVal !== 0 ? (pl / costVal) * 100 : 0;

      totalCostVal += costVal;
      totalMarketVal += marketVal;

      return { ...stock, costVal, marketVal, pl, plPercent };
    });

    const finalStocks = processed.map(stock => ({
      ...stock,
      weight: totalMarketVal !== 0 ? (stock.marketVal / totalMarketVal) * 100 : 0
    }));

    const totalPL = totalMarketVal - totalCostVal;
    const totalPLPercent = totalCostVal !== 0 ? (totalPL / totalCostVal) * 100 : 0;

    return { 
      processedStocks: finalStocks, 
      totals: { totalCostVal, totalMarketVal, totalPL, totalPLPercent, totalVol: stocks.reduce((acc, s) => acc + s.vol, 0) } 
    };
  }, [stocks]);

  const nav = totals.totalMarketVal + cashBalance;

  const handleStockUpdate = (index: number, field: keyof Stock, value: number) => {
    const newStocks = [...stocks];
    newStocks[index] = { ...newStocks[index], [field]: value };
    // Removed auto-sync logic for 'vol' -> 'avail' to allow independent editing
    setStocks(newStocks);
  };

  return (
    <div className="flex h-screen bg-[#0b0e11] text-gray-300 font-sans overflow-hidden">
      {/* CSS to hide spin buttons (arrows) for number inputs */}
      <style>{`
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        .no-spinner { 
          -moz-appearance: textfield; 
        }
      `}</style>

      {/* Sidebar */}
      <div className="w-14 flex flex-col items-center bg-[#15191f] border-r border-gray-800 pt-2 pb-4 justify-between z-20">
        <div className="flex flex-col gap-2">
          <div className="p-2 mb-2 text-blue-500 font-bold text-xl"><Menu size={24} /></div>
          <SidebarItem icon={Briefcase} active />
          <SidebarItem icon={BarChart2} />
          <SidebarItem icon={PieChart} />
          <SidebarItem icon={FileText} />
          <SidebarItem icon={Monitor} />
          <SidebarItem icon={MessageSquare} />
        </div>
        <div className="flex flex-col gap-4 mb-4"><SidebarItem icon={Bell} /></div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col min-w-0">
        
        {/* Header */}
        <header className="h-12 bg-[#15191f] border-b border-gray-800 flex items-center justify-between px-4">
          <div className="flex items-center gap-4">
             <span className="text-blue-500 font-bold text-lg tracking-wider">BSC</span>
             <div className="flex items-center gap-2 bg-[#1e2329] px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-700">
               <span>Tài sản</span>
               <X size={14} className="text-gray-500 hover:text-white" />
             </div>
             <div className="text-gray-500 text-sm cursor-pointer hover:text-white">Tùy chỉnh 1</div>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex flex-col items-end text-right text-xs">
               <span className="text-white font-medium">PHAN VĂN TUẤN ANH.002C129714</span>
               <span className="text-gray-400">Thường - 0001087765</span>
            </div>
            <div className="bg-gray-700 p-1.5 rounded-full"><User size={16} /></div>
            <Search size={18} className="cursor-pointer" />
            <Bell size={18} className="cursor-pointer" />
            <Settings size={18} className="cursor-pointer" />
            <button className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-1.5 rounded">Giao dịch</button>
          </div>
        </header>

        {/* Scrollable Body */}
        <main className="flex-1 overflow-y-auto p-2 space-y-2">
          
          {/* Account Select */}
          <div className="bg-[#1e2329] p-2 rounded flex items-center gap-2 text-sm border border-gray-800">
             <div className="bg-[#2a2e39] px-3 py-1.5 rounded flex items-center gap-2 cursor-pointer"><span>002C129714 - PHAN VĂN TUẤN ANH</span></div>
             <div className="bg-[#2a2e39] px-3 py-1.5 rounded flex items-center gap-2 cursor-pointer"><span>Thường - 0001087765</span><ChevronDown size={14} /></div>
          </div>

          {/* Table Section */}
          <div className="bg-[#1e2329] rounded border border-gray-800 overflow-hidden">
             <div className="p-2 border-b border-gray-800 text-sm font-medium text-white flex justify-between">
               <span>Danh mục đầu tư</span>
             </div>
             <div className="overflow-x-auto">
               <table className="w-full text-xs text-right">
                 <thead className="bg-[#2a2e39] text-gray-400 h-8">
                   <tr>
                     <th className="px-2 text-center">Lệnh</th>
                     <th className="px-2 text-center">TP/SL</th>
                     <th className="px-2 text-left">Mã CK</th>
                     <th className="px-2 w-20">Tổng KL</th>
                     <th className="px-2 w-20">KL khả dụng</th>
                     <th className="px-2 w-24">Giá vốn</th>
                     <th className="px-2">Giá trị vốn</th>
                     <th className="px-2 w-24">Giá TT</th>
                     <th className="px-2">Giá trị TT</th>
                     <th className="px-2">Tỷ trọng</th>
                     <th className="px-2">Giá trị Lãi/Lỗ</th>
                     <th className="px-2">% Lãi/Lỗ</th>
                   </tr>
                 </thead>
                 <tbody className="text-white">
                   {processedStocks.map((stock, index) => {
                     const isProfit = stock.pl >= 0;
                     const colorClass = isProfit ? 'text-green-500' : 'text-red-500';

                     return (
                       <tr key={stock.id} className="border-b border-gray-800 hover:bg-[#2a2e39] transition-colors h-9">
                         <td className="px-2 text-center">
                           <div className="flex justify-center gap-1 text-[10px] font-bold">
                             <span className="bg-[#103020] text-green-500 px-1 py-0.5 rounded border border-green-900">Mua</span>
                             <span className="bg-[#301010] text-red-500 px-1 py-0.5 rounded border border-red-900">Bán</span>
                           </div>
                         </td>
                         <td className="px-2 flex justify-center items-center h-9"><ToggleSwitch /></td>
                         <td className="px-2 text-left font-bold text-white">{stock.symbol}</td>
                         
                         {/* Seamless Editable Total Volume */}
                         <td className="px-2">
                           <EditableNumber value={stock.vol} onChange={(val) => handleStockUpdate(index, 'vol', val)} />
                         </td>
                         
                         {/* Seamless Editable Available Volume */}
                         <td className="px-2">
                           <EditableNumber value={stock.avail} onChange={(val) => handleStockUpdate(index, 'avail', val)} />
                         </td>

                         {/* Seamless Editable Cost Price */}
                         <td className="px-2">
                            <EditableNumber value={stock.costPrice} onChange={(val) => handleStockUpdate(index, 'costPrice', val)} />
                         </td>
                         <td className="px-2 text-gray-400">{stock.costVal.toLocaleString()}</td>

                         {/* Seamless Editable Market Price */}
                         <td className="px-2">
                            <EditableNumber value={stock.marketPrice} onChange={(val) => handleStockUpdate(index, 'marketPrice', val)} />
                         </td>
                         <td className="px-2 font-medium">{stock.marketVal.toLocaleString()}</td>

                         <td className="px-2 text-gray-400">{stock.weight.toFixed(1)}%</td>
                         <td className={`px-2 ${colorClass} font-bold`}>{stock.pl.toLocaleString()}</td>
                         <td className={`px-2 ${colorClass}`}>{stock.plPercent.toFixed(2)}%</td>
                       </tr>
                     );
                   })}
                   <tr className="bg-[#1a1d24] font-bold text-xs h-9 border-t border-gray-600">
                     <td colSpan={3} className="px-2 text-center text-gray-400">TỔNG CỘNG</td>
                     <td className="px-2 text-white">{totals.totalVol.toLocaleString()}</td>
                     <td className="px-2"></td>
                     <td className="px-2"></td>
                     <td className="px-2 text-white">{totals.totalCostVal.toLocaleString()}</td>
                     <td className="px-2"></td>
                     <td className="px-2 text-white">{totals.totalMarketVal.toLocaleString()}</td>
                     <td className="px-2 text-white">100 %</td>
                     <td className={`px-2 ${totals.totalPL >= 0 ? 'text-green-500' : 'text-red-500'}`}>{totals.totalPL.toLocaleString()}</td>
                     <td className={`px-2 ${totals.totalPLPercent >= 0 ? 'text-green-500' : 'text-red-500'}`}>{totals.totalPLPercent.toFixed(2)} %</td>
                   </tr>
                 </tbody>
               </table>
             </div>
          </div>

          {/* Bottom Layout: Assets & Charts */}
          <div className="grid grid-cols-12 gap-2 h-80">
            
            {/* Column 1: Asset Info */}
            <div className="col-span-12 lg:col-span-3 bg-[#1e2329] rounded border border-gray-800 p-3 flex flex-col">
              <div className="font-bold text-white mb-2 text-sm border-b border-gray-700 pb-2">Tài sản (Tự động cập nhật)</div>
              <div className="flex-1 overflow-auto pr-1">
                <InfoRow label="Tài sản ròng (NAV)" value={nav.toLocaleString()} isHighlight valueColor="text-blue-400" />
                <InfoRow label="Sức mua cơ bản" value={cashBalance.toLocaleString()} isHighlight />
                <div className="py-2 border-b border-gray-800">
                   <div className="text-gray-400 text-sm mb-1">Trạng thái ký quỹ</div>
                   <div className="flex justify-between text-xs mt-1">
                      <span>Trạng thái</span>
                      <span className="text-green-500">An toàn</span>
                   </div>
                </div>
                <div className="py-2 flex justify-between items-center border-b border-gray-800 font-bold text-sm">
                   <span className="text-white">Phải trả</span>
                   <span className="text-white">0</span>
                </div>
              </div>
            </div>

            {/* Column 2: Cash Info (Editable Cash) */}
            <div className="col-span-12 lg:col-span-3 bg-[#1e2329] rounded border border-gray-800 p-3 flex flex-col">
               <div className="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                 <span className="font-bold text-white text-sm">Tiền tại BSC</span>
                 <span className="font-bold text-white text-sm">{cashBalance.toLocaleString()}</span>
               </div>
               <div className="flex-1 overflow-auto pr-1">
                 <div className="flex justify-between items-center py-2 border-b border-gray-800 font-bold">
                    <span className="text-gray-400">Tiền khả dụng</span>
                    {/* Seamless Editable Cash with no-spinner */}
                    <input 
                      type="number" 
                      value={cashBalance} 
                      onChange={(e) => setCashBalance(Number(e.target.value))}
                      className="bg-transparent text-white text-right w-24 p-0 rounded border-b border-transparent hover:border-gray-600 focus:border-blue-500 outline-none no-spinner"
                    />
                 </div>
                 <InfoRow label="Tiền cổ tức chờ về" value="0" />
                 <InfoRow label="Lãi tiền gửi" value="1,085" />
                 
                 <div className="mt-4 pt-2 border-t border-gray-700">
                    <div className="flex justify-between items-center py-2 font-bold text-sm border-t border-gray-800">
                        <span className="text-white">Tổng GT Chứng khoán</span>
                        <span className="text-white">{totals.totalMarketVal.toLocaleString()}</span>
                    </div>
                    <InfoRow label="Lãi/Lỗ danh mục" value={totals.totalPL.toLocaleString()} valueColor={totals.totalPL >= 0 ? "text-green-500" : "text-red-500"} />
                 </div>
               </div>
            </div>

            {/* Column 3: Chart */}
            <div className="col-span-12 lg:col-span-6 bg-[#1e2329] rounded border border-gray-800 flex flex-col">
              <div className="flex border-b border-gray-800">
                 <button className="px-4 py-2 text-sm text-gray-400">Phân bổ danh mục</button>
                 <button className="px-4 py-2 text-sm text-white font-bold border-t-2 border-blue-500 bg-[#2a2e39]">Hiệu suất đầu tư</button>
              </div>
              
              <div className="p-3 flex items-center justify-between gap-2 flex-wrap">
                 <div className="flex bg-[#2a2e39] rounded text-xs overflow-hidden">
                    {['1M', '3M', '6M', '1Y', 'YTD'].map(period => (
                      <button key={period} className={`px-3 py-1 hover:bg-gray-700 ${period === '6M' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}>{period}</button>
                    ))}
                 </div>
                 
                 <div className="flex items-center gap-2 text-xs">
                    <div className="bg-[#2a2e39] px-2 py-1 rounded text-gray-300 border border-gray-700">09/06/2025</div>
                    <span className="text-gray-500">-</span>
                    <div className="bg-[#2a2e39] px-2 py-1 rounded text-gray-300 border border-gray-700">09/12/2025</div>
                    <button className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Áp dụng</button>
                 </div>
              </div>

              <div className="px-4 py-1 text-xs text-white">
                 <span className="text-gray-400 mr-2">Tổng lãi/lỗ:</span>
                 <span className={`font-bold ${totals.totalPL >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                    {totals.totalPL.toLocaleString()}
                 </span>
              </div>
              
              <div className="flex-1 w-full min-h-0">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={chartData} margin={{ top: 5, right: 20, bottom: 5, left: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#333" vertical={false} />
                    <XAxis dataKey="date" hide />
                    <YAxis stroke="#666" fontSize={10} tickFormatter={(val) => `${val}%`} domain={['auto', 'auto']} axisLine={false} tickLine={false} />
                    <Tooltip contentStyle={{ backgroundColor: '#1e2329', borderColor: '#333' }} itemStyle={{ fontSize: '12px' }} />
                    <Line type="monotone" dataKey="profit" stroke="#22c55e" strokeWidth={2} dot={false} />
                    <Line type="monotone" dataKey="index" stroke="#3b82f6" strokeWidth={2} dot={false} strokeDasharray="3 3" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

          </div>

        </main>
      </div>
    </div>
  );
}